name: Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Pagesãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦ãªæ¨©é™
permissions:
  contents: read
  pages: write
  id-token: write

# åŒæ™‚å®Ÿè¡Œã‚’é˜²ã
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - uses: actions/checkout@v4
    
    # Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install dependencies
      run: |
        npm init -y
        npm install --save-dev \
          html-minifier-terser \
          clean-css-cli \
          terser \
          imagemin-cli \
          imagemin-webp \
          imagemin-pngquant \
          imagemin-mozjpeg \
          postcss \
          postcss-cli \
          autoprefixer \
          cssnano
    
    # HTMLã®æœ€é©åŒ–
    - name: Minify HTML
      run: |
        npx html-minifier-terser \
          --collapse-whitespace \
          --remove-comments \
          --remove-optional-tags \
          --remove-redundant-attributes \
          --remove-script-type-attributes \
          --remove-tag-whitespace \
          --use-short-doctype \
          --minify-css true \
          --minify-js true \
          -o index.html \
          index.html
    
    # CSSã®æœ€é©åŒ–
    - name: Optimize CSS
      run: |
        # PostCSSã®è¨­å®šã‚’ä½œæˆ
        echo '{
          "plugins": {
            "autoprefixer": {},
            "cssnano": {
              "preset": ["default", {
                "discardComments": { "removeAll": true },
                "normalizeWhitespace": true,
                "colormin": true,
                "mergeLonghand": true,
                "mergeRules": true,
                "minifyFontValues": true,
                "minifyGradients": true,
                "minifyParams": true,
                "minifySelectors": true,
                "normalizeCharset": true,
                "normalizeUrl": true,
                "reduceTransforms": true
              }]
            }
          }
        }' > postcss.config.json
        
        # å„CSSãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ€é©åŒ–
        for file in css/*.css; do
          if [ -f "$file" ]; then
            npx postcss "$file" -o "$file"
          fi
        done
    
    # JavaScriptã®æœ€é©åŒ–
    - name: Minify JavaScript
      run: |
        for file in js/*.js; do
          if [ -f "$file" ]; then
            npx terser "$file" \
              --compress \
              --mangle \
              --output "$file"
          fi
        done
    
    # ç”»åƒã®æœ€é©åŒ–ã¨WebPå¤‰æ›
    - name: Optimize Images
      run: |
        # WebPå¤‰æ›ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        mkdir -p image/webp
        
        # PNG/JPGç”»åƒã‚’æœ€é©åŒ–
        npx imagemin 'image/*.{jpg,jpeg,png}' \
          --out-dir=image \
          --plugin=pngquant \
          --plugin=mozjpeg
        
        # WebPç‰ˆã‚’ç”Ÿæˆ
        for file in image/*.{jpg,jpeg,png}; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            name="${filename%.*}"
            npx imagemin "$file" \
              --out-dir=image/webp \
              --plugin=webp
            mv "image/webp/${filename}" "image/webp/${name}.webp" 2>/dev/null || true
          fi
        done
    
    # ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
    - name: Clean up
      run: |
        # é–‹ç™ºç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        rm -f .gitignore README.md package*.json postcss.config.json
        
        # ã‚½ãƒ¼ã‚¹ãƒžãƒƒãƒ—ã‚’å‰Šé™¤
        find . -name "*.map" -type f -delete
    
    # gzipåœ§ç¸®ç‰ˆã®ä½œæˆ
    - name: Create compressed versions
      run: |
        # HTML, CSS, JSãƒ•ã‚¡ã‚¤ãƒ«ã®gzipç‰ˆã‚’ä½œæˆ
        find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) \
          -exec gzip -9 -k {} \;
    
    # ãƒ“ãƒ«ãƒ‰çµæžœã®ã‚µã‚¤ã‚ºãƒ¬ãƒãƒ¼ãƒˆ
    - name: Generate size report
      run: |
        echo "## ðŸ“Š Build Size Report" >> $GITHUB_STEP_SUMMARY
        echo "| File Type | Count | Total Size |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|------------|" >> $GITHUB_STEP_SUMMARY
        
        # HTML
        html_count=$(find . -name "*.html" -type f | wc -l)
        html_size=$(find . -name "*.html" -type f -exec du -ch {} + | grep total$ | cut -f1)
        echo "| HTML | $html_count | $html_size |" >> $GITHUB_STEP_SUMMARY
        
        # CSS
        css_count=$(find css -name "*.css" -type f | wc -l)
        css_size=$(find css -name "*.css" -type f -exec du -ch {} + | grep total$ | cut -f1)
        echo "| CSS | $css_count | $css_size |" >> $GITHUB_STEP_SUMMARY
        
        # JavaScript
        js_count=$(find js -name "*.js" -type f | wc -l)
        js_size=$(find js -name "*.js" -type f -exec du -ch {} + | grep total$ | cut -f1)
        echo "| JavaScript | $js_count | $js_size |" >> $GITHUB_STEP_SUMMARY
        
        # Images
        img_count=$(find image -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" \) | wc -l)
        img_size=$(find image -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" \) -exec du -ch {} + | grep total$ | cut -f1)
        echo "| Images | $img_count | $img_size |" >> $GITHUB_STEP_SUMMARY
    
    # GitHub Pagesè¨­å®šï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
    - name: Setup Pages
      if: github.ref == 'refs/heads/main'
      uses: actions/configure-pages@v4
    
    # Pagesã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
    - name: Upload Pages artifact
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-pages-artifact@v3
      with:
        path: .
    
    # GitHub Pagesã¸ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      id: deployment
      uses: actions/deploy-pages@v4
    
    # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
    - name: Deployment summary
      if: github.ref == 'refs/heads/main'
      run: |
        echo "## âœ… Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ Site has been deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ URL: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY